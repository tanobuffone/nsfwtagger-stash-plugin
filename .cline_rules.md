# NSFWTagger AI Plugin - Development Rules
# Project-specific rules for NSFWTagger development

## 1. ARCHITECTURE PRINCIPLES

### 1.1 Component Separation
- **Two-component system only**: `nsfwtag-plugin` (Stash UI) + `nsfwtag-processor` (Docker container)
- **No Stash API calls**: Plugin provides UI only, processing isolated in container
- **HTTP communication**: Plugin ↔ container communication via REST/WebSocket APIs
- **File-based workflow**: Processor discovers work via file system scanning

### 1.2 Technology Stack
- **Frontend**: React.js plugin for Stash UI
- **Backend**: Python FastAPI container with Ollama integration
- **AI Models**: Ollama-only (no LMStudio, no external APIs)
- **Communication**: HTTP/WebSocket between components

## 2. OLLAMA INTEGRATION RULES

### 2.1 Model Configuration
- **Primary Model**: `qwen3-vl-4b-instruct/Qwen3-VL-4B-Instruct-Q4_K_M.gguf`
- **Fallback Model**: `olmocr-2-7b-1025/olmOCR-2-7B-1025-Q4_K_M.gguf`
- **Auto-loading**: Models loaded automatically on container startup
- **Health checks**: Connection validation before batch processing

### 2.2 Processing Requirements
- **Vision analysis**: Full scene analysis with multiple frame captures
- **Frame optimization**: Optimize frames for LLM efficiency
- **Batch processing**: Process frames in optimized batches
- **Fallback handling**: Automatic fallback to secondary model on errors

## 3. PLUGIN DEVELOPMENT RULES

### 3.1 UI Requirements
- **4-button interface**: "NSFW Tag all", "NSFW Tag images", "NSFW Tag scenes", "Test LLM provider"
- **Button descriptions**: Each button must have clear action description
- **Progress tracking**: Real-time progress updates and status display
- **Settings panel**: Container endpoint configuration only

### 3.2 Communication Protocol
- **HTTP endpoints**: RESTful API calls to container
- **WebSocket support**: Real-time progress updates
- **Error handling**: Comprehensive error display and recovery options
- **No Stash integration**: Plugin communicates with container only

## 4. PROCESSOR DEVELOPMENT RULES

### 4.1 Workflow Implementation
- **Tag discovery**: Find items tagged with "NSFWAI-Tagme"
- **Content processing**: Extract frames/images from media
- **AI analysis**: Send optimized content to Ollama for tagging
- **Tag application**: Apply AI-generated tags to items
- **Cleanup**: Replace "NSFWAI-Tagme" with "NSFWAI_Tagged"

### 4.2 Video Processing
- **Shot detection**: Advanced shot boundary detection
- **Frame extraction**: Capture several frames per shot
- **Optimization**: Prepare frames for vision LLM efficiency
- **Batching**: Process frames in optimized batches

## 5. LOGGING AND MONITORING

### 5.1 Log Requirements
- **Timestamps**: All processing steps with precise timestamps
- **Metrics**: Frame counts, processing times, model usage statistics
- **Error context**: Detailed error information with recovery attempts
- **Progress tracking**: Real-time batch progress for debugging

### 5.2 Monitoring
- **Health endpoints**: Container health and Ollama connectivity checks
- **Performance metrics**: Processing speed and resource usage
- **Error recovery**: Automatic retry logic and fallback procedures

## 6. CONFIGURATION MANAGEMENT

### 6.1 Environment Variables
- **Single .env file**: Ollama settings and processing parameters only
- **Docker environment**: All processing configuration via environment variables
- **Plugin config**: Limited to container endpoint URL
- **No complex structures**: Simple key-value configuration

### 6.2 Validation
- **Startup validation**: Check all required components on startup
- **Connection testing**: Validate Ollama connectivity before processing
- **Configuration validation**: Ensure all required parameters are set

## 7. DEVELOPMENT WORKFLOW

### 7.1 MCP Tool Usage
- **filesystem**: All file operations and project restructuring
- **hyperbrowser**: Research, documentation gathering, similar project analysis
- **playwright**: UI testing and plugin validation
- **github**: Repository management, releases, issue tracking
- **sequentialthinking**: Complex planning and architecture decisions

### 7.2 Code Standards
- **Python**: PEP 8 compliance, type hints, comprehensive docstrings
- **JavaScript/React**: ESLint, modern ES6+, component composition patterns
- **Docker**: Multi-stage builds, security best practices, minimal images
- **Testing**: Unit tests, integration tests, end-to-end validation

## 8. SECURITY AND RELIABILITY

### 8.1 Security Principles
- **Local processing**: All AI processing happens locally
- **No external APIs**: Ollama-only architecture, no cloud dependencies
- **Container isolation**: Processing isolated in Docker containers
- **Input validation**: Comprehensive validation of all inputs

### 8.2 Reliability Requirements
- **Error recovery**: Automatic fallback to secondary model
- **Resource management**: Memory and CPU usage monitoring
- **Graceful degradation**: Continue processing on non-critical errors
- **Comprehensive logging**: Full debugging information for troubleshooting

## 9. PERFORMANCE TARGETS

### 9.1 Processing Goals
- **Video processing**: < 5 minutes per 5-minute video
- **Image processing**: < 30 seconds per image
- **Batch efficiency**: Optimized concurrent processing
- **Memory usage**: < 4GB RAM under normal operation

### 9.2 User Experience
- **Plugin loading**: Instant loading in Stash interface
- **Progress updates**: Real-time feedback during processing
- **Error handling**: Clear error messages and recovery suggestions
- **Setup simplicity**: Minimal configuration required

## 10. QUALITY ASSURANCE

### 10.1 Testing Strategy
- **Unit tests**: Component and function testing
- **Integration tests**: Plugin ↔ container communication
- **End-to-end tests**: Complete NSFWAI tagging workflow
- **Performance tests**: Processing speed and resource validation

### 10.2 Documentation
- **Code documentation**: Inline comments and comprehensive docstrings
- **API documentation**: OpenAPI specifications for container endpoints
- **User documentation**: Installation, configuration, troubleshooting guides
- **Architecture documentation**: System design and component interactions

## 11. DEPLOYMENT AND MAINTENANCE

### 11.1 Release Process
- **Versioning**: Semantic versioning (MAJOR.MINOR.PATCH)
- **Changelog**: Detailed changelog for each release
- **Compatibility**: Stash version compatibility matrix
- **Migration**: Clear migration guides for breaking changes

### 11.2 Community Support
- **Issue tracking**: GitHub issues for bug reports and features
- **Documentation**: Comprehensive user and developer documentation
- **Community engagement**: Active participation in Stash community forums
- **Regular updates**: Timely security and feature updates

---

**These rules ensure NSFWTagger maintains clean architecture, reliable operation, and excellent user experience while following Stash plugin best practices.**
